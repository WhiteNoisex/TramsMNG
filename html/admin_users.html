<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • User Management — TRAMS DB</title>
<style>
:root{
  --bg:#0b1220;--panel:#0f172a;--ink:#e6f0ff;--muted:#9fb1c8;--brand:#22d3ee;--danger:#ef4444;
  --border:#22314d;--card:#121b2e;--ghost:#1d2740;--ok:#22c55e;--warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(120deg,#0a0f1f,#0e1528 60%,#0a1020);color:var(--ink);font:15px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit;text-decoration:none}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:rgba(15,23,42,.7);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.logo{font-weight:800} .logo b{color:var(--brand)}
.top-nav{display:flex;gap:14px}
.top-nav a{color:var(--muted)}
.top-nav a.active{color:var(--ink);font-weight:700}
.content{max-width:1200px;margin:24px auto;padding:0 16px}
h1{margin:10px 0 14px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:16px}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
input[type="text"],input[type="password"],select{background:#0b1220;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
button{background:var(--brand);color:#00242b;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
button.ghost{background:var(--ghost);color:#d7e5ff;border:1px solid var(--border)}
button.warn{background:var(--warn);color:#1b1303}
button.danger{background:var(--danger);color:#fff}
.notice{margin:10px 0;padding:10px;border:1px solid var(--border);border-radius:10px;display:none}
.notice.show{display:block}
.notice.err{background:#2a0f13;color:#ffd9df;border-color:#5b1b24}
.notice.ok{background:#0f2a19;color:#d9ffea;border-color:#174f2f}
.table-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid var(--border);vertical-align:middle}
th{position:sticky;top:0;background:#0f172a}
tbody tr:hover{background:#0e1629}
.badge{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#1f2a44;color:#c7d3ea;font-size:12px;white-space:nowrap}
.badge.ok{background:#0f2a19;color:#bff8d4;border-color:#174f2f}
.badge.danger{background:#2a0f13;color:#ffd9df;border-color:#5b1b24}
.badge.warn{background:#2a2510;color:#ffe4b3;border-color:#4c3a10}
.inline{width:100%;min-width:120px}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
.small{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;color:#bcd}
.kv{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.kv > div{display:flex;align-items:center;gap:6px}
.sort{cursor:pointer;white-space:nowrap}
.sort::after{content:" ↕";opacity:.6}
.sort.asc::after{content:" ↑"}
.sort.desc::after{content:" ↓"}
hr.sep{border:0;border-top:1px solid var(--border);margin:14px 0}
</style>
</head>
<body>
  <header>
    <div class="logo">🚋 <b>TRAMS</b> DB</div>
    <nav class="top-nav">
      <a href="?A=search_basic.html">Tram Sorting</a>
      <a href="?A=logged.html">Admin Panel</a>
    </nav>
  </header>

  <main class="content">
    <h1>👑 Admin — User Management</h1>

    <div id="notice" class="notice"></div>

    <!-- Controls -->
    <section class="panel">
      <div class="controls kv">
        <div><strong>Search:</strong> <input id="q" type="text" placeholder="Name, UID, ID..." /></div>
        <div><strong>Perms:</strong>
          <select id="perms">
            <option value="">Any</option>
            <option>Admin</option>
            <option>Maintenance</option>
            <option>Driver</option>
            <option>Viewer</option>
          </select>
        </div>
        <div><strong>Status:</strong>
          <select id="status">
            <option value="">Any</option>
            <option value="active">Active</option>
            <option value="fired">Fired</option>
            <option value="loggedin">Logged In</option>
            <option value="loggedout">Logged Out</option>
          </select>
        </div>
        <div class="kv">
          <button class="ghost" id="refreshBtn">🔄 Refresh</button>
          <button class="ghost" id="clearBtn">✖ Clear</button>
        </div>
      </div>

      <div class="kv">
        <div><strong>Page:</strong>
          <button class="ghost" id="prev">Prev</button>
          <span id="page" class="small">1</span>
          <button class="ghost" id="next">Next</button>
        </div>
        <div><strong>Sort:</strong>
          <button class="ghost" data-sort="id">ID</button>
          <button class="ghost" data-sort="UserUID">UID</button>
          <button class="ghost" data-sort="FirstName">First</button>
          <button class="ghost" data-sort="LastName">Last</button>
          <button class="ghost" data-sort="Perms">Perms</button>
          <button class="ghost" data-sort="last_login">Last Login</button>
        </div>
      </div>
    </section>

    <!-- User table -->
    <section class="panel">
      <div class="table-wrap">
        <table id="userTable">
          <thead>
            <tr>
              <th class="sort" data-sort="id">ID</th>
              <th class="sort" data-sort="UserUID">UID</th>
              <th class="sort" data-sort="FirstName">First</th>
              <th class="sort" data-sort="LastName">Last</th>
              <th class="sort" data-sort="Perms">Perms</th>
              <th>Logged In</th>
              <th>Status</th>
              <th class="sort" data-sort="last_login">Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><!-- rows injected --></tbody>
        </table>
      </div>

      <div class="pager">
        <button class="ghost" id="prev2">Prev</button>
        <span id="page2" class="small">Page 1</span>
        <button class="ghost" id="next2">Next</button>
      </div>
    </section>

    <!-- Add new -->
    <section class="panel">
      <h2>Add New User</h2>
      <div class="kv">
        <input placeholder="First Name" id="newFirst" />
        <input placeholder="Last Name" id="newLast" />
        <select id="newPerms">
          <option value="Admin">Admin</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Driver">Driver</option>
          <option value="Viewer">Viewer</option>
        </select>
        <input placeholder="Password" id="newPass" type="password"/>
        <button id="addBtn">➕ Add</button>
      </div>
      <div class="notice" id="addMsg"></div>
    </section>

    <hr class="sep"/>
 </main>

<script>
// ====== Config / Session ======
const masterServer = "http://localhost/tramsMNG";
const username = sessionStorage.getItem("username") || "Guest";
const token = sessionStorage.getItem("token") || "";

// Simple guard
if (!token || username === "Guest") {
  // You can redirect if you want:
  // location.href = "?A=dashboard.html";
}

// ====== DOM ======
const notice = document.getElementById("notice");
const qEl = document.getElementById("q");
const permsEl = document.getElementById("perms");
const statusEl = document.getElementById("status");
const refreshBtn = document.getElementById("refreshBtn");
const clearBtn = document.getElementById("clearBtn");
const table = document.getElementById("userTable");
const tbody = table.querySelector("tbody");

const prev = document.getElementById("prev");
const next = document.getElementById("next");
const pageLbl = document.getElementById("page");
const prev2 = document.getElementById("prev2");
const next2 = document.getElementById("next2");
const pageLbl2 = document.getElementById("page2");

const addFirst = document.getElementById("newFirst");
const addLast  = document.getElementById("newLast");
const addPerms = document.getElementById("newPerms");
const addPass  = document.getElementById("newPass");
const addBtn   = document.getElementById("addBtn");
const addMsg   = document.getElementById("addMsg");

// ====== State ======
let users = [];
let page = 1, pageSize = 25;
let sortKey = "id", sortDir = "asc";

// ====== Utils ======
const debounce = (fn, ms=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
const esc = s => String(s ?? "").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
function showNotice(msg, isErr=false){ notice.textContent = msg; notice.className = "notice show "+(isErr?"err":"ok"); }
function hideNotice(){ notice.className = "notice"; notice.textContent = ""; }
function showAddMsg(msg, isErr=false){ addMsg.textContent = msg; addMsg.className = "notice show "+(isErr?"err":"ok"); }
function hideAddMsg(){ addMsg.className = "notice"; addMsg.textContent = ""; }

// ====== API wrappers (adjust endpoints server-side as needed) ======
async function api(path, bodyObj){
  const res = await fetch(`${masterServer}${path}`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ Username: username, Token: token, ...(bodyObj||{}) })
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

// Endpoints (kept compatible with your original snippet)
const EP = {
  list:      "/api/get_users_API_2342.php",
  update:    "/api/update_users_API_2434.php",
  delete:    "/api/remove_user_API_678yy.php",
  create:    "/api/CreateAC_API_hjkhUYIGH75.php"
};

// ====== Load & render ======
async function fetchUsers() {
  try {
    hideNotice();
    const payload = {
      q: qEl.value || "",
      perms: permsEl.value || "",
      status: statusEl.value || "",
      page, pageSize,
      sortKey, sortDir
    };
    const data = await api(EP.list, payload);
    // Expect either an array or {rows, total}
    const rows = Array.isArray(data) ? data : (data.rows || []);
    users = rows;
    render(rows);
  } catch (e) {
    showNotice(`Failed to load users: ${e.message}`, true);
  }
}

function render(rows){
  tbody.innerHTML = rows.map(u => {
    const logged = u.loggedin ? `<span class="badge ok">✅ Logged In</span>` : `<span class="badge">❌ Logged Out</span>`;
    const status = u.Fired ? `<span class="badge danger">🔥 Fired</span>` : `<span class="badge ok">Active</span>`;
    return `
      <tr>
        <td>${esc(u.id)}</td>
        <td>${esc(u.UserUID)}</td>
        <td>${inlineText(u.id,"FirstName",u.FirstName)}</td>
        <td>${inlineText(u.id,"LastName",u.LastName)}</td>
        <td>${inlineSelect(u.id,"Perms",u.Perms)}</td>
        <td>${logged}</td>
        <td>${status}</td>
        <td>${esc(u.last_login || "")}</td>
        <td class="actions">
          <button class="${u.Fired?'':'warn'}" data-act="toggle" data-id="${u.id}" data-fired="${u.Fired?1:0}">${u.Fired ? "Rehire" : "Fire"}</button>
          <button class="danger" data-act="delete" data-id="${u.id}">❌ Delete</button>
        </td>
      </tr>`;
  }).join("");

  pageLbl.textContent = String(page);
  pageLbl2.textContent = `Page ${page}`;
}

function inlineText(id, field, val){
  return `<input class="inline" data-id="${id}" data-field="${field}" value="${esc(val??"")}" />`;
}
function inlineSelect(id, field, val){
  const opts = ["Admin","Maintenance","Driver","Viewer"];
  const html = opts.map(o=>`<option ${val===o?"selected":""}>${o}</option>`).join("");
  return `<select class="inline" data-id="${id}" data-field="${field}">${html}</select>`;
}

// ====== Inline update (debounced) ======
const pushUpdate = debounce(async (id, field, value) => {
  try{
    await api(EP.update, { id, field, value });
    // Optional toast:
    // showNotice(`Saved ${field}.`);
  }catch(e){
    showNotice(`Save failed: ${e.message}`, true);
  }
}, 450);

tbody.addEventListener("input", (e)=>{
  const t = e.target;
  const id = Number(t.dataset.id);
  const field = t.dataset.field;
  if (!id || !field) return;
  pushUpdate(id, field, t.value);
});

// ====== Row actions ======
tbody.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-act]");
  if (!btn) return;
  const id = Number(btn.dataset.id);
  const act = btn.dataset.act;

  try{
    if (act === "reset") {
      if (!confirm("Reset this user's API/login token?")) return;
      await api(EP.resetTok, { id });
      showNotice("🔑 Token reset.");
    }
    if (act === "toggle") {
      const fired = Number(btn.dataset.fired) === 1;
      const newVal = fired ? 0 : 1;
      if (!confirm(fired ? "Rehire this user?" : "Fire this user?")) return;
      await api(EP.update, { id, field:"Fired", value:newVal });
      showNotice(fired ? "User rehired." : "User fired.", !fired && false);
    }
    if (act === "delete") {
      if (!confirm("Permanently delete this user? This cannot be undone.")) return;
      await api(EP.delete, { id });
      showNotice("❌ User deleted.");
    }
    // Refresh to reflect changes
    await fetchUsers();
  }catch(err){
    showNotice(err.message, true);
  }
});

// ====== Paging / Sorting / Filters ======
function setSort(k){
  if (sortKey === k) {
    sortDir = (sortDir === "asc") ? "desc" : "asc";
  } else {
    sortKey = k; sortDir = "asc";
  }
  // header state
  document.querySelectorAll("th.sort, button[data-sort]").forEach(el=>{
    el.classList.remove("asc","desc");
    if ((el.dataset.sort||"") === k) el.classList.add(sortDir);
  });
  page = 1; fetchUsers();
}
document.querySelectorAll("th.sort, button[data-sort]").forEach(el=>{
  el.addEventListener("click", ()=> setSort(el.dataset.sort));
});

prev.addEventListener("click", ()=>{ if(page>1){ page--; fetchUsers(); }});
next.addEventListener("click", ()=>{ page++; fetchUsers(); });
prev2.addEventListener("click", ()=>{ if(page>1){ page--; fetchUsers(); }});
next2.addEventListener("click", ()=>{ page++; fetchUsers(); });

qEl.addEventListener("input", debounce(()=>{ page=1; fetchUsers(); }, 280));
permsEl.addEventListener("change", ()=>{ page=1; fetchUsers(); });
statusEl.addEventListener("change", ()=>{ page=1; fetchUsers(); });
refreshBtn.addEventListener("click", ()=> fetchUsers());
clearBtn.addEventListener("click", ()=>{
  qEl.value=""; permsEl.value=""; statusEl.value=""; page=1; sortKey="id"; sortDir="asc"; fetchUsers();
});

// ====== Add new user ======
addBtn.addEventListener("click", async ()=>{
  hideAddMsg();
  const body = {
    FirstName: addFirst.value.trim(),
    LastName: addLast.value.trim(),
    Perms: addPerms.value,
    Password: addPass.value
  };
  if (!body.FirstName || !body.LastName || !body.Password){
    showAddMsg("Please fill all required fields.", true); return;
  }
  try{
    await api(EP.create, body);
    showAddMsg("User created.", false);
    addFirst.value=""; addLast.value=""; addPass.value="";
    await fetchUsers();
  }catch(e){
    showAddMsg("Create failed: "+e.message, true);
  }
});

// ====== Kick off ======
fetchUsers();
</script>
</body>
</html>
