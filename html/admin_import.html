<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bulk Tram Upload — TRAMS DB</title>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--ink:#e6f0ff;--muted:#9fb1c8;--brand:#22d3ee;--border:#22314d}
*{box-sizing:border-box} 
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border)}
.wrap{max-width:900px;margin:20px auto;padding:0 16px}
.form{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;display:grid;gap:12px}
label{font-weight:600;margin-bottom:4px;display:block}
input,select,textarea{width:100%;border:1px solid var(--border);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px}
textarea{min-height:140px;resize:vertical}
.btn{background:var(--brand);color:#00242b;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
.notice{margin-top:12px;padding:10px;border-radius:10px;border:1px solid var(--border)}
.ok{background:#0f2a19;color:#d9ffea;border-color:#174f2f}
.err{background:#2a0f13;color:#ffd9df;border-color:#5b1b24}
.small{font-family:ui-monospace,monospace;color:#bcd}
</style>
</head>
<body>
<header class="header">
  <a href="?A=logged.html">← Dashboard</a>
  <strong>Bulk Tram Upload</strong>
  <span id="who"></span>
</header>

<main class="wrap">
  <form id="uploadForm" class="form" autocomplete="off">
    <div>
      <label for="fileInput">Select Tram Data File</label>
      <input id="fileInput" type="file" accept=".csv,.json,.xml" required/>
    </div>

    <div>
      <label for="description">Description (optional)</label>
      <textarea id="description" name="Description" placeholder="Optional notes about this upload"></textarea>
    </div>

    <div>
      <button class="btn" type="submit">Upload File</button>
      <button class="btn" type="button" id="previewBtn" style="background:#17223b;color:#d7e5ff;border:1px solid var(--border)">Preview Payload</button>
    </div>

    <div id="msg" class="notice" hidden></div>
    <pre id="preview" class="small" hidden></pre>
  </form>
</main>

<script>
const masterServer = "https://web.interfacetools.com/TramsMNG";
const username = sessionStorage.getItem("username") || "Guest";
const token = sessionStorage.getItem("token") || "";
document.getElementById("who").textContent = username;

const form = document.getElementById("uploadForm");
const msg = document.getElementById("msg");
const preview = document.getElementById("preview");
const previewBtn = document.getElementById("previewBtn");

previewBtn.addEventListener("click", async () => {
  const payload = await buildPayload(false);
  preview.hidden = false;
  preview.textContent = JSON.stringify(payload, null, 2);
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg();
  try {
    const payload = await buildPayload(true);
    const res = await fetch(`${masterServer}/api/Tram_Upload.php`, {
      method: "POST",
      body: payload
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    showMsg(`Uploaded ${j.inserted} trains successfully.`, false);
  } catch(err) {
    showMsg(`Failed: ${err.message}`, true);
  }
});

async function buildPayload(asMultipart) {
  const fd = new FormData();
  const fileInput = document.getElementById("fileInput");
  const desc = document.getElementById("description").value;

  if(fileInput.files.length === 0) throw new Error("No file selected");
  fd.append("File", fileInput.files[0]);
  fd.append("Username", username);
  fd.append("Token", token);
  fd.append("Description", desc);

  if(asMultipart) return fd;

  return {
    Username: username,
    Token: token,
    Description: desc,
    FileName: fileInput.files[0].name,
    FileType: fileInput.files[0].type
  };
}

function showMsg(text, isError) {
  msg.hidden = false;
  msg.textContent = text;
  msg.className = "notice " + (isError ? "err" : "ok");
}

function hideMsg() { msg.hidden = true; }
</script>
</body>
</html>
