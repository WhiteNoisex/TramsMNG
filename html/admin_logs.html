<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Logs — TRAMS DB</title>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--ink:#e6f0ff;--muted:#9fb1c8;--brand:#22d3ee;--border:#22314d}
*{box-sizing:border-box} body{margin:0;background:#0a1020;color:var(--ink);font:15px/1.55 system-ui}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0f172a;border-bottom:1px solid var(--border)}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
.panel{background:#0f172a;border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
.grid{display:grid;gap:12px}
@media(min-width:880px){.grid.three{grid-template-columns:1fr 1fr 1fr}}
input,select{width:100%;border:1px solid var(--border);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px}
.btn{background:var(--brand);color:#00242b;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
.table{border:1px solid var(--border);border-radius:8px;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
.pager button{background:#17223b;color:#d7e5ff;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}
.small{font-family:ui-monospace,monospace;color:#bcd}
</style>
</head>
<body>
<header class="header">
  <a href="?A=logged.html">← Dashboard</a>
  <strong>Admin Logs</strong>
  <span id="who"></span>
</header>

<main class="wrap">
  <section class="panel grid three">
    <div>
      <label>Type</label>
      <select id="type">
        <option value="">Any</option>
        <option>Auth</option>
        <option>DriverRecord</option>
        <option>ServiceTicket</option>
        <option>Registry</option>
        <option>System</option>
      </select>
    </div>
    <div>
      <label>User</label>
      <input id="user" placeholder="username"/>
    </div>
    <div>
      <label>Tram ID</label>
      <input id="tram" placeholder="e.g. 001"/>
    </div>
    <div>
      <label>From</label>
      <input id="from" type="datetime-local"/>
    </div>
    <div>
      <label>To</label>
      <input id="to" type="datetime-local"/>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="search" class="btn">Search</button>
    </div>
  </section>

  <section class="panel">
    <div class="table">
      <table>
        <thead>
          <tr><th>Time</th><th>User</th><th>Type</th><th>Detail</th><th>IP</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="pager">
      <button id="prev">Prev</button>
      <span id="page" class="small">Page 1</span>
      <button id="next">Next</button>
    </div>
  </section>
</main>

<script>
const masterServer = "http://localhost/tramsMNG";
const username = sessionStorage.getItem("username") || "Guest";
const token = sessionStorage.getItem("token") || "";
document.getElementById("who").textContent = username;

const els = {
  type:document.getElementById("type"), user:document.getElementById("user"), tram:document.getElementById("tram"),
  from:document.getElementById("from"), to:document.getElementById("to"),
  search:document.getElementById("search"), rows:document.getElementById("rows"),
  prev:document.getElementById("prev"), next:document.getElementById("next"), page:document.getElementById("page")
};
let curPage = 1, pageSize = 25, lastCount = 0;

els.search.addEventListener("click", ()=>{ curPage=1; load(); });
els.prev.addEventListener("click", ()=>{ if(curPage>1){ curPage--; load(); }});
els.next.addEventListener("click", ()=>{ if(lastCount===pageSize){ curPage++; load(); }});

async function load(){
  els.rows.innerHTML = `<tr><td colspan="5" class="small">Loading…</td></tr>`;
  const q = {
    Username: username, Token: token, Page: curPage, PageSize: pageSize,
    Type: els.type.value||null, User: els.user.value||null, Tram_ID: els.tram.value||null,
    From: els.from.value||null, To: els.to.value||null
  };
  try{
    const res = await fetch(`${masterServer}/api/Admin_Logs_List.php`,{
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(q)
    });
    if(!res.ok) throw 0;
    const j = await res.json(); // expect { rows:[...], count: N<=pageSize }
    render(j.rows||[]); lastCount = (j.rows||[]).length;
    els.page.textContent = `Page ${curPage}`;
  }catch{
    els.rows.innerHTML = `<tr><td colspan="5" class="small">Failed to load.</td></tr>`;
  }
}
function render(rows){
  if(!rows.length){ els.rows.innerHTML = `<tr><td colspan="5" class="small">No results.</td></tr>`; return; }
  els.rows.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.Time||"")}</td>
      <td>${esc(r.User||"")}</td>
      <td>${esc(r.Type||"")}</td>
      <td class="small">${esc(typeof r.Detail==="string"?r.Detail:JSON.stringify(r.Detail))}</td>
      <td>${esc(r.IP||"")}</td>
    </tr>
  `).join("");
}
function esc(s){return String(s??"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
load();
</script>
</body>
</html>
